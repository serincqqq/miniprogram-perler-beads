<!--index.wxml-->
<navigation-bar title="拼豆图转换器" back="{{false}}" color="black" background="#FFF"></navigation-bar>
<view class="page-container">

  <!-- 图片上传区域 -->
  <view bind:tap="onChooseImage" class="uploader-container">
    <view class="uploader-content">
      <image class="uploader-icon" src="/static/upload.png"></image>
      <text class="uploader-text-main">拖放图片到此处，或<text class="uploader-link">点击选择文件</text></text>
      <text class="uploader-text-sub">支持 JPG, PNG 格式</text>
    </view>
  </view>

  <!-- 参数设置区域 -->
  <view class="card-container">
    <!-- 横轴格子 -->
    <view class="setting-item">
      <text class="setting-label">横轴格子 (10-200):</text>
      <view class="setting-control input-group">
        <input class="setting-input" type="number" value="{{gridSize}}" bindinput="onGridSizeInput" maxlength="3" />
        <button class="setting-button" size="mini" type="primary" bindtap="confirmGridSize">确认</button>
      </view>
    </view>

    <!-- 区域颜色合并 -->
    <view class="setting-item slider-item">
      <text class="setting-label">区域颜色合并: {{mergeLevel}}</text>
      <view class="setting-control slider-group">
        <text class="slider-label-min">少</text>
        <slider class="setting-slider" value="{{mergeLevel}}" min="1" max="100" bindchange="onMergeLevelChange" show-value="{{false}}" activeColor="#8A2BE2" block-size="20" />
        <text class="slider-label-max">多</text>
      </view>
    </view>

    <!-- 选择色板 -->
    <view class="setting-item">
      <text class="setting-label">选择色板:</text>
      <view class="setting-control">
        <picker class="setting-picker" mode="selector" range="{{paletteOptions}}" value="{{paletteIndex}}" bindchange="onPaletteChange">
          <view class="picker-content">
            {{paletteOptions[paletteIndex]}}
            <!-- <image class="picker-arrow" src="/images/down-arrow.png"></image> -->
          </view>
        </picker>
      </view>
    </view>

    <!-- 处理模式 -->
    <view class="setting-item">
      <text class="setting-label">处理模式:</text>
      <view class="setting-control">
        <picker class="setting-picker" mode="selector" range="{{modeOptions}}" value="{{modeIndex}}" bindchange="onModeChange">
          <view class="picker-content">
            {{modeOptions[modeIndex]}}
            <!-- <image class="picker-arrow" src="/images/down-arrow.png"></image>  -->
          </view>
        </picker>
      </view>
    </view>
  </view>
  <view class="result-container">
    <!-- wx:if 控制显示，style 控制尺寸 -->
    <canvas wx:if="{{imagePath}}" id="previewCanvas" type="2d" style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"></canvas>
    <!-- 可以加一个图片未选择时的提示 -->
    <view wx:else class="placeholder-text">请先选择图片</view>
  </view>

  <!-- 网格控制面板 -->
  <view class="grid-controls">
    <view class="control-section">
      <text class="section-title">单元格边界微调</text>
      <view class="slider-row">
        <text class="slider-label">左线{{leftValue.toFixed(1)}}</text>
        <slider class="grid-slider" min="0" max="40" step="0.2" value="{{mainLeftAxis}}" bindchange="onAxisChange" data-type="left" />

      </view>
      <view class="slider-row">
        <text class="slider-label">右线{{rightValue.toFixed(1)}}</text>
        <slider class="grid-slider" min="0" max="40" value="{{mainRightAxis}}" bindchange="onAxisChange" data-type="right" step="0.2" />
      </view>
      <view class="slider-row">
        <text class="slider-label">上线{{topValue.toFixed(1)}}</text>
        <slider class="grid-slider" min="0" max="40" value="{{mainTopAxis}}" bindchange="onAxisChange" data-type="top" step="0.2" />
      </view>
      <view class="slider-row">
        <text class="slider-label">下线{{bottomValue.toFixed(1)}}</text>
        <slider class="grid-slider" min="0" max="40" value="{{mainBottomAxis}}" bindchange="onAxisChange" data-type="bottom" step="0.2" />
      </view>
    </view>
    <button size="mini" bindtap="resetMainAxes" class="reset-button">重置边界</button>
    <button class="setting-button" size="mini" type="primary" bindtap="exportImg">导出</button>
  </view>

  <!-- 在页面底部添加校准弹窗 -->
  <view class="calibration-modal" wx:if="{{showCalibrationModal}}" catchtouchmove="moveAxis" bindtouchend="stopMoveAxis">
    <view class="calibration-container">
      <view class="calibration-header">
        <text class="calibration-title">单元格校准</text>
        <text class="calibration-close" bindtap="closeCalibrationModal">×</text>
      </view>

      <view class="calibration-instruction">
        <text>请拖动四条红线框选一个单元格，然后点击"应用"</text>
      </view>

      <view class="calibration-image-container">
        <image class="calibration-image" src="{{calibrationImg}}" mode="aspectFit"></image>

        <!-- 修改为像素定位 -->
        <view class="axis vertical-axis left-axis" style="left: {{leftAxis}}px" bindtouchstart="startMoveAxis" data-axis="left"></view>

        <view class="axis vertical-axis right-axis" style="left: {{rightAxis}}px" bindtouchstart="startMoveAxis" data-axis="right"></view>

        <view class="axis horizontal-axis top-axis" style="top: {{topAxis}}px" bindtouchstart="startMoveAxis" data-axis="top"></view>

        <view class="axis horizontal-axis bottom-axis" style="top: {{bottomAxis}}px" bindtouchstart="startMoveAxis" data-axis="bottom"></view>

        <!-- 选中区域高亮 -->
        <view class="selected-area" style="left: {{leftAxis}}px; top: {{topAxis}}px; width: {{rightAxis - leftAxis}}px; height: {{bottomAxis - topAxis}}px"></view>
      </view>

      <view class="calibration-buttons">
        <button class="calibration-button cancel" bindtap="closeCalibrationModal">取消</button>
        <button class="calibration-button apply" bindtap="applyCalibration">应用</button>
      </view>
    </view>
  </view>

</view>